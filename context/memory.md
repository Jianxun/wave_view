# Project Memory

## Project Overview
Wave_view is a Python package for SPICE simulation visualization with a modern, user-friendly API. The project features core modules for configuration management (config.py), data reading (reader.py), and plotting (plotter.py), with comprehensive YAML-based configuration support and advanced features like log scale plotting and processed signal generation.

## Current State

### **Architecture: Clean 3-Step Workflow**
```python
# Step 1: Discovery - "What's available?"
signals = wv.explore_signals("simulation.raw")

# Step 2: Configuration - "What do I want?"  
config = {...}  # Explicit user choices

# Step 3: Plotting - "Show me the results"
fig = wv.plot("simulation.raw", config)  # Required config, no magic
```

### **Package Status** 
- **Installation**: `pip install -e .` (development mode)
- **Test Coverage**: ✅ **ALL PASSING**: 234 passing, 0 failing (includes new AC complex number tests)
- **API Coverage**: 87% with comprehensive validation
- **Overall Coverage**: 91% with comprehensive test suite
- **Repository Structure**: Modern src/ layout ready for PyPI publication
- **Documentation**: ✅ **COMPLETE** - Professional Sphinx documentation with comprehensive guides
- **Current Branch**: `remove_multi_figure_support` (all phases complete)
- **Git Status**: All multi-figure removal changes committed (Phase 3: 3efeb71)

### **Core Modules Status**
- **SpiceData (reader.py)**: 100% coverage, case-insensitive signal access
- **PlotConfig (config.py)**: 96% coverage, YAML configuration system
- **SpicePlotter (plotter.py)**: 95% coverage, advanced Plotly integration
- **API (api.py)**: 87% coverage, comprehensive input validation

### **Key API Functions**
- `plot()` - Main plotting function with required config parameter
- `load_spice()` - SPICE file loading with Path object support
- `explore_signals()` - Signal discovery with categorized output
- `validate_config()` - Configuration validation with helpful warnings
- `config_from_file()` - Load configuration from YAML files
- `config_from_yaml()` - Create configuration from YAML strings

### **Documentation System** ✅ **COMPLETE & UPDATED**
- **Sphinx Setup**: Professional documentation with Read the Docs theme
- **Comprehensive Structure**:
  - User guides (installation, quickstart, configuration, examples)
  - API reference with autosummary and cross-references
  - Core modules documentation
  - Development guides (changelog, contributing)
- **Build System**: Clean HTML generation with minimal warnings
- **Configuration Format**: ✅ **UPDATED** - All examples now use correct YAML X/Y format instead of deprecated dictionary plots format
- **Ready for Publication**: Documentation ready for hosting and user onboarding

## Key Decisions

### **API Design Philosophy**
- **Explicit over implicit**: No hidden magic, all behavior transparent
- **Path object support**: Modern pathlib integration throughout
- **Comprehensive validation**: Clear error messages guide users
- **Test-driven development**: All features have comprehensive test coverage

### **Configuration System**
- **YAML-based**: Flexible configuration with file, string, or dict input
- **Multi-figure support**: Single config can define multiple plots
- **Processed data integration**: Users can pass computed signals via `processed_data` parameter
- **Log scale support**: Both X and Y axes support logarithmic scaling

### **Signal Handling**
- **Case-insensitive**: All signal names normalized to lowercase
- **Signal categorization**: Voltage (v()), current (i()), and other signals
- **Path objects**: Consistent Union[str, Path] support across all functions

### **Documentation Strategy**
- **Sphinx-based**: Professional documentation system with modern theme
- **User-focused**: Clear tutorials and examples for common use cases
- **API-complete**: Comprehensive reference with autogenerated content
- **Development-ready**: Contributing guides and development setup instructions

## API Changes Successfully Implemented ✅

### **Explicit Configuration API**
- **Removed auto-detection**: PlotConfig constructor only accepts Path, dict, or list
- **Added factory functions**: `config_from_file()`, `config_from_yaml()`, `config_from_dict()`
- **Simplified API surface**: Removed `plot_batch()` function
- **Enhanced type safety**: Proper isinstance() checks and type validation

### **Test Fixes Completed** ✅
All 23 failing tests have been successfully fixed:

1. **PlotConfig Constructor Tests** (11 tests) - Updated to use factory functions
2. **plot() Function API Tests** (4 tests) - Updated mock expectations for PlotConfig objects
3. **plot_batch Tests** (8 tests) - Removed entire test file as function was deleted
4. **Internal Method Tests** (4 tests) - Removed TestFilePathDetection class
5. **Type Import Issues** (1 test) - Fixed isinstance() checks with proper imports

### **Code Quality Improvements Completed** ✅

#### **Signal Categorization Utility** 
- **Location**: `src/wave_view/api.py`
- **Change**: Extracted `_categorize_signals()` utility function from `explore_signals()`
- **Benefit**: Reusable logic for voltage/current/other signal categorization
- **Return**: `Tuple[List[str], List[str], List[str]]` for (voltage, current, other) signals

#### **Named Constants**
- **Location**: `src/wave_view/core/reader.py`
- **Change**: Added `MAX_SIGNALS_TO_SHOW = 5` constant
- **Replaced**: Hardcoded `[:5]` slice in error messages
- **Benefit**: Better maintainability and readability

#### **Type Annotations**
- **Location**: `src/wave_view/api.py`
- **Functions Updated**: 
  - `_configure_plotly_renderer() -> None`
  - `_is_jupyter_environment() -> bool`
- **Benefit**: Complete type coverage on all API functions

### **Documentation System Completed** ✅

#### **Sphinx Configuration**
- **Extensions**: autodoc, autosummary, napoleon, intersphinx, myst-parser
- **Theme**: Read the Docs theme with professional navigation
- **Build System**: Clean HTML generation with autosummary support
- **Cross-references**: Intersphinx links to Python, NumPy, Plotly docs

#### **Documentation Structure**
- **User Guides**: Installation, quickstart, configuration, examples
- **API Reference**: Complete function documentation with autosummary
- **Core Modules**: Internal module documentation for developers
- **Development**: Changelog and contributing guidelines

#### **Content Quality**
- **Tutorial-based**: 3-step workflow clearly explained with examples
- **Example-rich**: Practical use cases for common scenarios
- **Configuration-complete**: Comprehensive guide to all options
- **Development-ready**: Clear setup and contribution instructions

### **Key Changes Made**
- Updated all tests to use `config_from_file()` instead of passing file paths to PlotConfig
- Updated all tests to use `config_from_yaml()` instead of passing YAML strings to PlotConfig
- Fixed mock expectations to expect PlotConfig objects instead of dictionaries
- Removed tests for deprecated auto-detection functionality
- Fixed isinstance() type checking issues in path support tests
- Created comprehensive Sphinx documentation with professional structure
- Set up autosummary for automatic API reference generation
- Configured Read the Docs theme with proper navigation and cross-references

## Recent Updates ✅ **COMPLETED**
1. **PyPI Release Preparation**: Package fully prepared for PyPI publication with modernized metadata, CI/CD workflows, and validated distribution files
2. **GitHub Actions CI/CD**: Added automated testing workflow (Python 3.8-3.12) and PyPI publishing workflow with trusted publishing
3. **Package Metadata Modernization**: Updated to SPDX license format, correct author information, and proper GitHub URLs
4. **Type Information Support**: Added py.typed marker file for proper type information distribution
5. **Documentation Configuration Format Update**: All Sphinx documentation examples updated from deprecated dictionary `plots` format to current YAML `X`/`Y` axis structure
6. **Configuration Examples Modernized**: Updated quickstart.rst, index.rst, configuration.rst, and examples.rst with proper YAML configurations
7. **API Consistency**: Documentation now correctly shows `config_from_yaml()` and `config_from_file()` usage instead of raw dictionaries
8. **Signal Reference Simplification**: Removed all `raw.` prefixes from signal references since signals default to raw file signals (e.g., `raw.time` → `time`, `raw.frequency` → `frequency`)

## Current Issues Identified

### **Multi-Figure Removal Progress** ✅ **PHASE 1.5 COMPLETED**
**PHASE 1** ✅ - PlotConfig class and factory function updates (81dfc2e)
- ✅ **PlotConfig Class**: Removed `is_multi_figure`, `figure_count`, `get_figure_config()` methods
- ✅ **Factory Functions**: Updated `config_from_yaml()` and `config_from_file()` to reject YAML lists
- ✅ **Error Messages**: Added helpful migration guidance for multi-figure rejection

**PHASE 1.5** ✅ **COMPLETED** - Critical SpicePlotter Fix & All Test Updates (c851d92)
- ✅ **SpicePlotter Fix**: Updated `create_figure()` to use `config.config` directly instead of removed methods
- ✅ **Comprehensive Test Updates**: Fixed all 31 failing tests across basic, config, and plotter test suites
- ✅ **Multi-Figure Migration Tests**: Updated tests to verify proper rejection with helpful error messages
- ✅ **Single-Figure API**: All tests now use direct config access pattern for single-figure support
- ✅ **Test Results**: 220 passing, 0 failing (was 189 passing, 31 failing)

**PHASE 2** ✅ **COMPLETED** - Documentation and Examples Cleanup (09df5ac)
- ✅ **Documentation Updates**: Removed multi-figure references from docs/index.rst, configuration.rst, and examples.rst
- ✅ **README Updates**: Updated features list, examples, and configuration format to current single-figure API
- ✅ **Example Files**: Converted multi-figure examples to demonstrate separate configuration approach
- ✅ **CHANGELOG**: Added breaking change documentation and migration guidance
- ✅ **Migration Guidance**: All documentation shows recommended separate plot() calls approach

**PHASE 3** ✅ **COMPLETED** - Final Cleanup and Validation (3efeb71)
- ✅ **Integration Test Fix**: Updated `test_package_integration.py` to use `config_from_file()` instead of removed properties
- ✅ **Test Helper Cleanup**: Updated `get_multi_figure_test_config()` docstring to clarify rejection testing purpose
- ✅ **Obsolete Test Removal**: Removed obsolete multi-figure validation tests from `test_config_validation.py`
- ✅ **Final Validation**: All 220 tests passing, 91% coverage, multi-figure removal comprehensive and complete
- ✅ **Branch Status**: Ready for merge - all multi-figure functionality cleanly removed with proper migration guidance

### **UI Polish Improvements** ✅ **COMPLETED**
1. **Zoom Button Configuration**: ✅ Existing `show_zoom_buttons` configuration works correctly
2. **Zoom XY Functionality**: ✅ Fixed broken zoom XY button - now properly resets all axis fixedrange properties
3. **Plot Title Alignment**: ✅ Implemented center-aligned titles by default with configurable positioning

#### **Technical Implementation Details**
- **Fixed Zoom XY Bug**: Updated zoom button args to explicitly set `xaxis.fixedrange: False` and `yaxis.fixedrange: False`
- **Title Configuration**: Added structured title object with `x` and `xanchor` properties (default: center)
- **Configuration Options**: Added `title_x` and `title_xanchor` for custom title positioning
- **Backward Compatibility**: All existing configurations continue to work unchanged

### **Recently Fixed Issues** ✅

#### **AC Simulation Complex Number Parsing** ✅ **FIXED**
- **Issue**: AC analysis results were returning only real numbers instead of complex numbers
- **Root Cause**: Line 118 in `src/wave_view/core/reader.py` forced `dtype=float` conversion, discarding imaginary parts
- **Fix**: Removed `dtype=float` parameter to preserve original data types from spicelib
- **Impact**: Transfer function analysis (magnitude/phase) now works correctly for AC simulations
- **Test Coverage**: Added comprehensive test suite in `tests/unit_tests/reader/test_reader_complex_numbers.py`
- **Verification**: ✅ Complex signals preserved, magnitude/phase calculations work, mixed real/complex signals supported

#### **Plotly JSON Serialization for Complex Numbers** ✅ **FIXED**
- **Issue**: "Object of type complex is not JSON serializable" when plotting AC data
- **Root Cause**: Complex numbers from raw AC signals were passed directly to Plotly without conversion
- **Fix**: Added complex number handling in plotter's `_get_signal_data()` function to convert complex raw signals to real parts
- **Impact**: AC frequency response plots now display correctly without JSON serialization errors
- **Verification**: ✅ AC analysis plots work, transient analysis unaffected, all tests pass

#### **Documentation Updates for AC Analysis** ✅ **COMPLETED**
- **Updated examples.rst**: Replaced basic AC example with comprehensive complex signal processing guide
- **Enhanced quickstart.rst**: Added AC analysis section to advanced features
- **Updated index.rst**: Added "Complex Signal Processing" to features list
- **Content Added**: Bode plot examples, transfer function analysis, complex number handling guide
- **Documentation Build**: ✅ Successfully built with new AC analysis examples

### **Other Issues**
- **Error message enhancement opportunity** for signal name suggestions (reader.py:97-101)

## Open Questions
None - AC simulation complex number parsing issue has been resolved.

## Next Steps

### **AC Simulation Data Parsing Investigation** (NEXT SESSION)
1. **Examine AC Raw File Format**: Understand how complex numbers are stored in SPICE AC analysis files
2. **Debug reader.py Logic**: Check if complex number parsing is implemented correctly
3. **Test Transfer Function Workflow**: Verify magnitude/phase calculations work as expected
4. **User Experience**: Ensure AC analysis data is accessible and usable for frequency response plots

### **Completed Sprints**

### **Multi-Figure Removal Sprint** ✅ **COMPLETED**
- **Phase 1**: ✅ **COMPLETED** - Core removal from PlotConfig class and tests  
- **Phase 1.5**: ✅ **COMPLETED** - Critical plotter fix and comprehensive test updates
- **Phase 2**: ✅ **COMPLETED** - Documentation and examples cleanup
- **Phase 3**: ✅ **COMPLETED** - Final cleanup and validation
- **Result**: Multi-figure support completely removed with clean migration path

### **UI Polish Sprint** (After Multi-Figure Completion)
1. **Zoom Button Configuration**: Add option to disable zoom buttons
2. **Zoom XY Functionality**: Fix broken zoom XY button behavior  
3. **Plot Title Alignment**: Center-justify plot titles

### **Future Work**
1. **PyPI Publication**: Execute final PyPI release (package prepared, pending completion of current changes)
2. **Enhanced Error Messages**: Add fuzzy matching suggestions for signal name typos
3. **Documentation Hosting**: Consider Read the Docs or GitHub Pages for documentation hosting
4. **Post-Release**: Monitor PyPI metrics, gather user feedback, plan next version features
